<!-- login.html -->
<form id="signupForm">
  <input id="suEmail" type="email" placeholder="Email" required>
  <input id="suPass" type="password" placeholder="Password" required>
  <button type="submit">Sign Up</button>
</form>

<form id="loginForm">
  <input id="liEmail" type="email" placeholder="Email" required>
  <input id="liPass" type="password" placeholder="Password" required>
  <button type="submit">Log In</button>
</form>

<button id="logoutBtn" style="display:none">Log out</button>

<script type="module">
  const {
    auth, db, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
    doc, setDoc, serverTimestamp
  } = window.firebaseDeps;

  // Create user + profile doc
  document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = suEmail.value.trim();
    const pass = suPass.value;
    const cred = await createUserWithEmailAndPassword(auth, email, pass);

    // Create a user profile doc (public info only)
    await setDoc(doc(db, "users", cred.user.uid), {
      email,
      createdAt: serverTimestamp(),
      lastActiveAt: serverTimestamp(),
      role: "user" // can be "admin" later via claims
    });

    alert('Signed up. You can now log in.');
  });

  // Login
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = liEmail.value.trim();
    const pass = liPass.value;
    await signInWithEmailAndPassword(auth, email, pass);
    // Optional: redirect to calculator or dashboard
    window.location.href = 'index.html';
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
  });

  // UI state
  onAuthStateChanged(auth, async (user) => {
    document.getElementById('logoutBtn').style.display = user ? 'inline-block' : 'none';
    if (user) {
      // Update lastActiveAt
      await setDoc(doc(db, "users", user.uid), { lastActiveAt: serverTimestamp() }, { merge: true });
    }
  });
</script>

<!-- Script for authentication -->
<script type="module">
 
  const firebaseConfig = {
    apiKey: "AIzaSyCI0zbu9vXg4j26loOHVExJSoEee-7E7LU",
    authDomain: "unza-s-site.firebaseapp.com",
    projectId: "unza-s-site",
    storageBucket: "unza-s-site.firebasestorage.app",
    messagingSenderId: "691190316366",
    appId: "1:691190316366:web:da52c76c6f6380faccb21f",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
    getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, addDoc,
    collection, collectionGroup, query, orderBy, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getFunctions, httpsCallable }
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-functions.js";

  const app = initializeApp(firebaseConfig);
  window.firebaseDeps = {
    app,
    auth: getAuth(app),
    db: getFirestore(app),
    functions: getFunctions(app),
    // helpers re-exported for convenience:
    onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, getIdTokenResult,
    doc, setDoc, getDoc, addDoc, collection, collectionGroup, query, orderBy, getDocs, serverTimestamp, httpsCallable
  };
</script>
